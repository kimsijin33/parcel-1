name: mailserver
version: '0.1'
summary: A mailserver in a single snap
description: |
  There are a few pieces that you need to manage your own mail server.
  This snap makes the process easy, it will setup most things that
  you expect from a mail server. Because the process is automated and
  easy expect the installation to be somewhat unflexible.

base: core18
grade: devel
confinement: strict

apps:
  mailserver:
    command: "true"

  postmulti:
    command: postmulti
    plugs:
      - network
      - network-bind

  postfix:
    command: postfix
    plugs:
      - network
      - network-bind

  sendmail:
    command: sendmail
    plugs:
      - network

  postconf:
    command: postconf
    plugs:
      - network

  shell:
    command: /bin/bash
    plugs:
      - network
      - network-bind

passthrough:
  layout:
    /etc/overlay/config:
      bind: $SNAP_DATA/config
    /etc/overlay/shlibs:
      bind: $SNAP/usr/lib
#    /usr/sbin/postdrop:
#      symlink: $SNAP/usr/sbin/postdrop

parts:
  shell:
    plugin: nil
    stage-packages:
      - bash

  postfix:
    plugin: make
    source: ftp://ftp.aptget.dk/postfix/postfix-release/official/postfix-3.3.2.tar.gz
    override-build: |
      make makefiles dynamicmaps=yes shared=yes shlib_directory=/etc/overlay/shlibs config_directory=/etc/overlay/config
      make
      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/share
      mkdir -p $SNAPCRAFT_PART_INSTALL/etc/postfix
      cp -rv man $SNAPCRAFT_PART_INSTALL/usr/share
      cp -rv meta $SNAPCRAFT_PART_INSTALL/usr/share
      cp -rv bin $SNAPCRAFT_PART_INSTALL/bin
      cp -r libexec $SNAPCRAFT_PART_INSTALL/usr
      cp -r lib $SNAPCRAFT_PART_INSTALL/usr
      cp -r conf/* $SNAPCRAFT_PART_INSTALL/etc/postfix
    build-packages:
      - build-essential
      - m4
      - libdb-dev

  dovecot:
    plugin: nil
