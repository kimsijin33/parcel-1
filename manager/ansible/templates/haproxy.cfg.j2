global
    maxconn 4096

defaults
    maxconn 4096
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    mode http

listen smtp
  bind *:25
  mode tcp
  option smtpchk HELO {{ postfix_domain }}
  server postfix {{ hostvars['postfix']['ansible_default_ipv4']['address'] }}:25 send-proxy check

listen imaps
  bind *:993
  balance leastconn
  option tcp-check
  tcp-check connect port 993 ssl
  tcp-check expect string * OK
  stick store-request src
  stick-table type ip size 200k expire 30m
  server dovecot {{ hostvars['postfix']['ansible_default_ipv4']['address'] }}:993 send-proxy-v2 check verify none

listen sieve
  bind *:4190
  option tcp-check
  server sieve {{ hostvars['dovecot']['ansible_default_ipv4']['address'] }}:4190 check

listen stats
  bind *:8080
  stats enable
  stats hide-version
  stats auth admin:password
  stats uri /

